apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: virushack-prediction-api
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: virushack-prediction-api
        role: virushack-prediction-api
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: cloud.google.com/gke-nodepool
                operator: In
                values:
                - main-pool
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            preference:
              matchExpressions:
              - key: cloud.google.com/gke-nodepool
                operator: In
                values:
                - main-pool
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - virushack-prediction-api
            topologyKey: "kubernetes.io/hostname"
      containers:
        - image: gcr.io/virushack-prediction-cluster/virushack-prediction-api:staging
          imagePullPolicy: IfNotPresent
          name: api
          securityContext:
            privileged: true
          command:
          - /bin/sh
          - -c
          - >
            set -o allexport &&
            supervisord -c /etc/supervisord.conf &&
            sleep infinity & wait;
          ports:
            - containerPort: 80
              name: api
      nodeSelector:
        role: main